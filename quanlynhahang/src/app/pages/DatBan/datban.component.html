<div class="page-container">

  <div class="page-header">
    <h2>Qu·∫£n l√Ω ƒë·∫∑t b√†n</h2>
  </div>

  <div class="filter-bar">
    <dx-button
      text="Th√™m ƒë·∫∑t b√†n"
      icon="plus"
      stylingMode="contained"
      type="default"
      [elementAttr]="{ class: 'btn-add-ban' }"
      (onClick)="openAddModal()">
    </dx-button>
  </div>

  <dx-data-grid
    [dataSource]="datBans"
    [showBorders]="true"
    [columnAutoWidth]="true"
    keyExpr="id">

    <dxo-paging [pageSize]="5"></dxo-paging>
    <dxo-pager [showInfo]="true"></dxo-pager>
    <dxo-filter-row [visible]="true" [applyFilter]="'auto'"></dxo-filter-row>

    <dxi-column caption="STT" width="60" cellTemplate="sttTpl"></dxi-column>
    <dxi-column caption="Th√¥ng tin kh√°ch h√†ng" cellTemplate="khTpl"></dxi-column>
    <dxi-column caption="Chi ti·∫øt ƒë∆°n h√†ng" cellTemplate="datBanTpl"></dxi-column>
    
    <dxi-column dataField="trangThai" caption="Tr·∫°ng th√°i" width="180" cellTemplate="statusTpl">
      <dxo-lookup [dataSource]="['Ch·ªù duy·ªát', 'ƒêang ph·ª•c v·ª•', 'Ho√†n th√†nh', 'ƒê√£ h·ªßy']"></dxo-lookup>
    </dxi-column>

    <dxi-column caption="H√†nh ƒë·ªông" width="280" cellTemplate="actionTpl"></dxi-column>

    <div *dxTemplate="let data of 'sttTpl'">{{ data.rowIndex + 1 }}</div>

    <div *dxTemplate="let data of 'khTpl'">
      <b>M√£ h√≥a ƒë∆°n:</b> {{ data.data.maHoaDon }}<br>
      <b>Ng√†y ƒë·∫∑t:</b> {{ data.data.ngayDat | date:'dd/MM/yyyy HH:mm' }}<br>
      <b>Kh√°ch h√†ng:</b> {{ data.data.hoVaTen }}
    </div>

    <div *dxTemplate="let data of 'datBanTpl'">
      <b>B√†n s·ªë:</b> {{ data.data.soBan }} ({{ data.data.soNguoi }} ng∆∞·ªùi)<br>
      
      <div style="margin-top: 6px; display: flex; align-items: center; gap: 8px;">
        <span style="font-weight: bold;">M√≥n g·ªçi:</span>
        <dx-button 
            icon="eyeopen" 
            hint="Xem chi ti·∫øt m√≥n"
            stylingMode="outlined"
            type="default"
            [height]="28"
            [width]="40"
            (onClick)="openFoodModal(data.data)">
        </dx-button>
        <span style="font-size: 12px; color: #666;">({{ data.data.orderFood?.length || 0 }} m√≥n)</span>
      </div>

      <div style="margin-top: 6px;">
          <b>TT:</b> {{ data.data.payment }} - <b style="color: #d63031;">{{ formatMoney(data.data.totalAmount) }}</b>
      </div>
    </div>

    <div *dxTemplate="let data of 'statusTpl'">
      <span class="status"
        [ngClass]="{
          'pending': data.data.originalStatus === 'Waiting',
          'paid': data.data.originalStatus === 'CONFIRMED',
          'done': data.data.originalStatus === 'COMPLETED',
          'cancel': data.data.originalStatus === 'CANCELLED'
        }">
        {{ data.data.trangThai }}
      </span>
    </div>

    <div *dxTemplate="let data of 'actionTpl'">
      
      <dx-button 
        *ngIf="data.data.originalStatus !== 'COMPLETED' && data.data.originalStatus !== 'CANCELLED'"
        text="H·ªßy" type="danger" stylingMode="contained" class="ml-1" 
        (onClick)="huy(data.data)">
      </dx-button>

      <dx-button 
        *ngIf="data.data.originalStatus !== 'COMPLETED' && data.data.originalStatus !== 'CANCELLED'"
        text="S·ª≠a" type="default" stylingMode="outlined" class="ml-1" 
        (onClick)="openEditModal(data.data)">
      </dx-button>

      <dx-button 
        *ngIf="data.data.originalStatus === 'Waiting'"
        text="Duy·ªát" type="success" stylingMode="contained" class="ml-1" 
        (onClick)="duyet(data.data)">
      </dx-button>

      <dx-button 
        *ngIf="data.data.originalStatus === 'CONFIRMED'"
        text="Thanh to√°n" type="default" stylingMode="contained" class="ml-1" 
        (onClick)="openPaymentPopup(data.data)">
      </dx-button>

    </div>

  </dx-data-grid>
</div>

<dx-popup 
    [(visible)]="isPopupVisible" 
    [title]="isEditMode ? 'C·∫≠p nh·∫≠t ƒë∆°n ƒë·∫∑t b√†n' : 'T·∫°o ƒë∆°n ƒë·∫∑t b√†n m·ªõi'" 
    [width]="1100" 
    [height]="650" 
    [showCloseButton]="true">
    
    <div *dxTemplate="let data of 'content'">
        <div class="booking-layout">
            
            <div class="col-table">
                <h4 class="col-title">1. Ch·ªçn B√†n</h4>
                <div class="table-list">
                    <div *ngFor="let table of availableTables" 
                         class="table-item" 
                         [class.selected]="newOrder.tableNumber === table.tenBan"
                         (click)="selectTable(table)"> 
                        <span class="t-num">{{ table.tenBan }}</span>
                        <span class="t-cap">{{ table.sucChua }} ch·ªó</span>
                    </div>
                    <div *ngIf="availableTables.length === 0" class="empty-msg">
                        <i class="dx-icon dx-icon-info"></i> H·∫øt b√†n tr·ªëng!
                    </div>
                </div>
            </div>

            <div class="col-menu">
                <h4 class="col-title">2. Ch·ªçn M√≥n ƒÇn</h4>
                <dx-tabs [dataSource]="menuCategories" [selectedIndex]="0" (onItemClick)="onTabChange($event)"></dx-tabs>

                <div class="menu-list">
                    <div class="menu-item" *ngFor="let item of filteredMenu">
                        <dx-check-box [(value)]="item.selected" (onValueChanged)="updateSelection(item)"></dx-check-box>
                        <div class="item-info">
                            <div class="item-name">{{ item.ten }}</div>
                            <div class="item-price">{{ formatMoney(item.gia) }}</div>
                        </div>
                        <div class="item-qty" *ngIf="item.selected">
                            <dx-number-box [(value)]="item.quantity" [min]="1" [width]="60" (onValueChanged)="updateSelection(item)"></dx-number-box>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-info">
                <h4 class="col-title">3. Th√¥ng tin</h4>
                
                <div class="form-group"><label>B√†n ƒë√£ ch·ªçn:</label><div class="highlight-text">{{ newOrder.tableNumber || '...' }}</div></div>
                <div class="form-group"><label>T√™n kh√°ch h√†ng:</label><dx-text-box [(value)]="newOrder.customer" placeholder="Nh·∫≠p t√™n kh√°ch"></dx-text-box></div>
                <div class="form-group"><label>S·ªë ng∆∞·ªùi:</label><dx-number-box [(value)]="newOrder.peopleCount" [min]="1" [showSpinButtons]="true" format="#"></dx-number-box></div>
                
                <div class="form-group">
                    <label>Ph∆∞∆°ng th·ª©c TT:</label>
                    <dx-select-box [items]="paymentMethods" [(value)]="newOrder.payment"></dx-select-box>
                </div>

                <div class="total-section">
                    <span>T·ªïng ti·ªÅn m√≥n:</span>
                    <span class="total-price">{{ formatMoney(newOrder.totalAmount) }}</span>
                </div>

                <div class="popup-footer">
                    <dx-button 
                        [text]="isEditMode ? 'C·∫¨P NH·∫¨T ƒê∆†N' : 'X√ÅC NH·∫¨N ƒê·∫∂T B√ÄN'" 
                        type="success" width="100%" height="45" icon="check"
                        (onClick)="saveOrder()">
                    </dx-button>
                </div>
            </div>

        </div>
    </div>
</dx-popup>

<dx-popup
    [(visible)]="isFoodPopupVisible"
    title="Danh s√°ch m√≥n ƒë√£ g·ªçi"
    [width]="400"
    [height]="'auto'"
    [showCloseButton]="true"
    [dragEnabled]="true">
    
    <div *dxTemplate="let data of 'content'">
        <dx-list [dataSource]="currentFoodView" [height]="300">
            <div *dxTemplate="let item of 'item'">
                <div style="font-weight: 500; padding: 8px; border-bottom: 1px dashed #eee;">
                    üçΩÔ∏è {{ item }}
                </div>
            </div>
        </dx-list>
        
        <div style="text-align: center; margin-top: 15px;">
            <dx-button text="ƒê√≥ng" type="normal" (onClick)="isFoodPopupVisible = false"></dx-button>
        </div>
    </div>
</dx-popup>

<dx-popup
  [(visible)]="isPaymentPopupVisible"
  title="THANH TO√ÅN ƒê∆†N H√ÄNG"
  [width]="500"
  [height]="550"
  [showCloseButton]="true"
  [dragEnabled]="false">
  
  <div *dxTemplate="let data of 'content'">
    <div class="payment-container" style="padding: 15px;">
      
      <h2 style="text-align: center; color: #565eef; margin: 0 0 20px 0;">
        B√ÄN {{ paymentData.tableNumber }}
      </h2>

      <div style="text-align: center; color: #666; margin-bottom: 20px; font-style: italic;">
        M√£ ƒë∆°n: {{ paymentData.orderId | slice:-6 }}
      </div>

      <div style="display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 16px;">
        <span style="color: #666;">T·ªïng ti·ªÅn m√≥n:</span>
        <span style="font-weight: 600;">{{ formatMoney(paymentData.subTotal) }}</span>
      </div>

      <div style="background: #f3f4f6; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
        <div style="display: flex; gap: 10px;">
            <dx-text-box 
                placeholder="Nh·∫≠p m√£ KM (n·∫øu c√≥)" 
                [(value)]="paymentData.discountCode"
                width="100%">
            </dx-text-box>
            <dx-button 
                text="√Åp d·ª•ng" 
                type="default" 
                stylingMode="contained"
                (onClick)="checkPromotion()">
            </dx-button>
        </div>
        
        <div *ngIf="paymentData.discountPercent > 0" 
             style="margin-top: 10px; color: #dc2626; display: flex; justify-content: space-between;">
            <span>Gi·∫£m gi√° ({{ paymentData.discountPercent }}%):</span>
            <span>- {{ formatMoney(paymentData.discountValue) }}</span>
        </div>
      </div>

      <hr style="border: 1px dashed #ccc; margin: 20px 0;">

      <div style="display: flex; justify-content: space-between; margin-bottom: 30px; font-size: 20px;">
        <strong>KH√ÅCH C·∫¶N TR·∫¢:</strong>
        <strong style="color: #059669; font-size: 24px;">
            {{ formatMoney(paymentData.finalAmount) }}
        </strong>
      </div>

      <dx-button 
          text="X√ÅC NH·∫¨N THANH TO√ÅN" 
          type="success" 
          width="100%" 
          height="50"
          icon="check"
          (onClick)="confirmPayment()">
      </dx-button>

    </div>
  </div>
</dx-popup>